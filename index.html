<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vote for Your Top 3 Favorite Videos</title>
<script async src="https://embed.redditmedia.com/widgets/platform.js" charset="UTF-8"></script>
<style>
  body { font-family: Arial; background:#111; color:#fff; padding:20px; max-width:1200px; margin:auto; }
  h1,h2,p { text-align:center; }
  .video-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(360px,1fr)); gap:20px; margin-bottom:40px; }
  .video-card { background:#222; border-radius:8px; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.3);}
  #rankingSection { background:#222; padding:20px; border-radius:10px; }
  #rankingList { list-style:none; padding:0; margin-top:20px; }
  #rankingList li { padding:10px 15px; margin:10px 0; background:#333; border:1px solid #555; border-radius:5px; cursor:grab; transition:background 0.3s; }
  #rankingList li.top1 { background:#d4af37; color:#111; font-weight:bold; }
  #rankingList li.top2 { background:#c0c0c0; color:#111; font-weight:bold; }
  #rankingList li.top3 { background:#cd7f32; color:#111; font-weight:bold; }
  #submitBtn { margin-top:20px; padding:10px 20px; font-size:16px; display:block; margin:auto; cursor:pointer; }
  #responseMsg { text-align:center; font-weight:bold; margin-top:20px; }
  #hiddenGoogleForm { display:none; }
  .judge-criteria { max-width:600px; margin:auto; }
  .judge-criteria ul { padding-left:100px; text-align:left; list-style-position:inside; }
</style>
</head>
<body>

<h1>Vote for Your Top 3 Favorite Videos</h1>
<p>Watch the videos below, then drag the titles to rank your top 3.</p>

<h2>Judge the videos based on the following criteria:</h2>
<div class="judge-criteria">
  <ul>
    <li>The video quality and cinematography of the clip</li>
    <li>Authentic track sound over low-effort background music</li>
    <li>Title of the video, how descriptive and informative it is</li>
  </ul>
</div>

<div class="video-grid" id="videoGrid"></div>

<div id="rankingSection">
  <h2>Drag to Rank Top 3</h2>
  <ul id="rankingList"></ul>
  <button id="submitBtn">Submit Vote</button>
  <p id="responseMsg"></p>
</div>

<!-- Hidden Google Form -->
<form id="hiddenGoogleForm" action="https://docs.google.com/forms/d/1wUIPXtUV5HqQtNMwfj5D4Kk0MGMsQRMvOnWLfOD8aIA/formResponse" method="POST" target="hiddenIframe">
  <input type="text" name="entry.840683232" id="field1" /> 
  <input type="text" name="entry.1808098160" id="field2" /> 
  <input type="text" name="entry.1134855181" id="field3" /> 
</form>
<iframe name="hiddenIframe" style="display:none;"></iframe>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.esm.js";

const firebaseConfig = {
  apiKey: "AIzaSyDChk83uv5LqXHemAziEHO3YAqEROHjIbo",
  authDomain: "rotm-2a088.firebaseapp.com",
  projectId: "rotm-2a088",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const videoGrid = document.getElementById("videoGrid");
const rankingList = document.getElementById("rankingList");

// Helper to update top 3 styling
function updateTop3Styling() {
  [...rankingList.children].forEach((li, i) => {
    li.classList.remove("top1","top2","top3");
    const text = li.textContent.replace(/^\d+\.\s*/, "");
    if(i===0){ li.classList.add("top1"); li.textContent=`1. ${text}`; }
    else if(i===1){ li.classList.add("top2"); li.textContent=`2. ${text}`; }
    else if(i===2){ li.classList.add("top3"); li.textContent=`3. ${text}`; }
    else li.textContent=text;
  });
}

// Load posts from GitHub JSON
async function loadPosts() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/vpsj/rotm_test/main/links.json");
    const urls = await res.json();
    
    const embedPromises = urls.map(async (url, i) => {
      const postId = "video"+(i+1);

      // Reddit card
      const cardHTML = `<div class="video-card"><blockquote class="reddit-card"><a href="${url}">Loading title...</a></blockquote></div>`;
      videoGrid.insertAdjacentHTML("beforeend", cardHTML);

      // Fetch Reddit data for title and upvotes
      try {
        const jsonRes = await fetch(url+".json");
        const json = await jsonRes.json();
        const data = json[0].data.children[0].data;
        const title = data.title || url;

        const li = document.createElement("li");
        li.textContent = title;
        li.setAttribute("data-id", postId);
        rankingList.appendChild(li);
      } catch(e) {
        console.error("Failed to fetch Reddit data:", url, e);
        const li = document.createElement("li");
        li.textContent = url;
        li.setAttribute("data-id", postId);
        rankingList.appendChild(li);
      }
    });

    await Promise.all(embedPromises);

    Sortable.create(rankingList, {
      animation:150,
      onEnd:updateTop3Styling
    });
    updateTop3Styling();

  } catch(err) {
    console.error("Failed to load posts:", err);
  }
}

// Submit vote
document.getElementById("submitBtn").addEventListener("click", async () => {
  const top3 = [...rankingList.children].slice(0,3).map(li => li.textContent.replace(/^\d+\.\s*/,""));

  // Firebase
  await addDoc(collection(db, "votes"), {
    userId: "anon_" + Math.floor(Math.random()*10000),
    rank1: top3[0]||null,
    rank2: top3[1]||null,
    rank3: top3[2]||null,
    timestamp: serverTimestamp()
  });

  // Google Form
  document.getElementById("field1").value = top3[0]||"";
  document.getElementById("field2").value = top3[1]||"";
  document.getElementById("field3").value = top3[2]||"";
  document.getElementById("hiddenGoogleForm").submit();

  document.getElementById("responseMsg").innerText = "Your vote has been submitted. Thank you!";
});

loadPosts();
</script>
</body>
</html>

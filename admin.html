<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROTM Admin Dashboard</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<style>
body { font-family: Arial; background:#111; color:#fff; padding:20px; max-width:1200px; margin:auto; }
h1, h2 { text-align:center; }
table { width:100%; border-collapse:collapse; margin-bottom:30px; }
th, td { border:1px solid #444; padding:8px; text-align:left; }
th { background:#222; }
tr:nth-child(even) { background:#1a1a1a; }
.tabs { display:flex; justify-content:center; margin-bottom:20px; }
.tab { padding:10px 20px; cursor:pointer; background:#333; margin:0 5px; border-radius:5px; }
.tab.active { background:#555; }
.section { display:none; }
.section.active { display:block; }
button { background:#444; color:#fff; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; }
button:hover { background:#666; }
</style>
</head>
<body>
<h1>RailFan of the Month - Admin Dashboard</h1>

<div class="tabs">
  <div class="tab active" data-section="scores">Scores</div>
  <div class="tab" data-section="votes">Votes</div>
  <div class="tab" data-section="reset">Reset</div>
  <div class="tab" data-section="export">Export</div>
</div>

<div id="scores" class="section active">
  <h2>Video Rankings</h2>
  <table id="rankingTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Video Title</th>
        <th>Reddit Upvotes</th>
        <th>Upvote Points</th>
        <th>Vote Points</th>
        <th>Total Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="chart_div" style="width:100%; height:500px;"></div>
</div>

<div id="votes" class="section">
  <h2>All Votes</h2>
  <table id="votesTable">
    <thead>
      <tr>
        <th>User</th>
        <th>Rank 1</th>
        <th>Rank 2</th>
        <th>Rank 3</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="reset" class="section">
  <h2>Reset Votes</h2>
  <button id="resetVotesBtn">Delete All Votes</button>
</div>

<div id="export" class="section">
  <h2>Export Data</h2>
  <button id="exportCSVBtn">Export CSV</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const votesCol = collection(db, "votes");

let videosData = {};
let votesData = [];
let videosLoaded = false;
let votesLoaded = false;

// --- Fetch video list from links.json instead of Firestore ---
async function loadVideosFromJson() {
  videosData = {};
  try {
    const resp = await fetch("links.json");
    const links = await resp.json();

    for (const url of links) {
      const title = await fetchRedditTitle(url);
      const upvotes = await fetchRedditUpvotes(url);

      const id = url; // use URL as unique key
      videosData[id] = {
        title,
        upvotes,
        votePoints: 0,
        upvotePoints: 0,
        totalScore: 0,
        rank1Votes: 0,
        rank2Votes: 0,
        rank3Votes: 0
      };
    }
    videosLoaded = true;
    if (votesLoaded) calculateScores();
  } catch (e) {
    console.error("Failed to load links.json", e);
  }
}

async function fetchRedditTitle(url) {
  try {
    const resp = await fetch(url + ".json");
    const json = await resp.json();
    return json[0].data.children[0].data.title || url;
  } catch {
    return url;
  }
}

async function fetchRedditUpvotes(url) {
  try {
    const resp = await fetch(url + ".json");
    const json = await resp.json();
    return json[0].data.children[0].data.ups || 0;
  } catch {
    return 0;
  }
}

// --- Votes listener stays as-is ---
onSnapshot(votesCol, snapshot => {
  votesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  votesLoaded = true;
  if (videosLoaded) calculateScores();
  renderVotes();
});

// --- Scoring Logic ---
function calculateScores() {
  // reset counts
  for (const id in videosData) {
    videosData[id].votePoints = 0;
    videosData[id].upvotePoints = videosData[id].upvotes; 
    videosData[id].rank1Votes = 0;
    videosData[id].rank2Votes = 0;
    videosData[id].rank3Votes = 0;
  }

  votesData.forEach(v => {
    if (v.rank1) { videosData[v.rank1].votePoints += 30; videosData[v.rank1].rank1Votes++; }
    if (v.rank2) { videosData[v.rank2].votePoints += 20; videosData[v.rank2].rank2Votes++; }
    if (v.rank3) { videosData[v.rank3].votePoints += 10; videosData[v.rank3].rank3Votes++; }
  });

  for (const id in videosData) {
    const vid = videosData[id];
    vid.totalScore = vid.upvotePoints + vid.votePoints;
  }

  renderRanking();
  drawChart();
}

// --- Render Ranking ---
function renderRanking() {
  const tbody = document.querySelector("#rankingTable tbody");
  tbody.innerHTML = "";
  const sorted = Object.values(videosData).sort((a,b) => b.totalScore - a.totalScore);
  sorted.forEach((vid, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
                    <td>${vid.title}</td>
                    <td>${vid.upvotes}</td>
                    <td>${vid.upvotePoints}</td>
                    <td>${vid.votePoints}</td>
                    <td>${vid.totalScore}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Render Votes ---
function renderVotes() {
  const tbody = document.querySelector("#votesTable tbody");
  tbody.innerHTML = "";
  votesData.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.id}</td>
                    <td>${videosData[v.rank1]?.title || ""}</td>
                    <td>${videosData[v.rank2]?.title || ""}</td>
                    <td>${videosData[v.rank3]?.title || ""}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Chart ---
google.charts.load("current", {packages:["corechart"]});
function drawChart() {
  const data = new google.visualization.DataTable();
  data.addColumn("string", "Video");
  data.addColumn("number", "Total Score");
  const arr = Object.values(videosData).map(v => [v.title, v.totalScore]);
  data.addRows(arr);
  const chart = new google.visualization.ColumnChart(document.getElementById("chart_div"));
  chart.draw(data, {backgroundColor:"#111", legend:{textStyle:{color:"#fff"}}, hAxis:{textStyle:{color:"#fff"}}, vAxis:{textStyle:{color:"#fff"}}});
}

// --- Reset Votes ---
document.getElementById("resetVotesBtn").addEventListener("click", async () => {
  if (!confirm("Are you sure you want to delete all votes?")) return;
  const snap = await getDocs(votesCol);
  snap.forEach(d => deleteDoc(doc(db, "votes", d.id)));
});

// --- Export CSV ---
document.getElementById("exportCSVBtn").addEventListener("click", () => {
  let csv = "Rank,Title,Reddit Upvotes,Upvote Points,Vote Points,Total Score\n";
  const sorted = Object.values(videosData).sort((a,b) => b.totalScore - a.totalScore);
  sorted.forEach((vid, i) => {
    csv += `${i+1},"${vid.title}",${vid.upvotes},${vid.upvotePoints},${vid.votePoints},${vid.totalScore}\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ranking.csv";
  a.click();
});

// --- Tabs ---
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.section).classList.add("active");
  });
});

// --- Init ---
loadVideosFromJson();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ROTM Admin Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial; background:#111; color:#fff; padding:20px; max-width:1200px; margin:auto; }
    h1, h2 { text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #444; padding:8px; text-align:center; }
    th { background:#222; }
    button { margin-top:10px; padding:10px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>ROTM Admin Dashboard</h1>
  <button id="resetButton">Reset All Votes</button>

  <h2>Leaderboard</h2>
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Video</th>
        <th>Reddit Upvotes</th>
        <th>Upvote Score</th>
        <th>Voting Score</th>
        <th>Total Score</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart_div" style="width:100%; height:500px;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // TODO: put your firebaseConfig here
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const votesCol = collection(db, "votes");

    let videosData = {};
    let votesLoaded = false, videosLoaded = false;

    // Load videos from links.json
    async function loadVideosFromJson() {
      const resp = await fetch("links.json");
      const links = await resp.json();
      for (const url of links) {
        const title = await fetchRedditTitle(url);
        const redditUpvotes = await fetchRedditUpvotes(url);
        videosData[url] = {
          url,
          title,
          redditUpvotes,
          votePoints: 0,
          upvotePoints: 0,
          totalScore: 0
        };
      }
      videosLoaded = true;
      if (votesLoaded) calculateScores();
    }

    async function fetchRedditTitle(url) {
      try {
        const resp = await fetch(url + ".json");
        const json = await resp.json();
        return json[0].data.children[0].data.title;
      } catch {
        return url;
      }
    }

    async function fetchRedditUpvotes(url) {
      try {
        const resp = await fetch(url + ".json");
        const json = await resp.json();
        return json[0].data.children[0].data.ups || 0;
      } catch {
        return 0;
      }
    }

    // Listen to votes collection
    onSnapshot(votesCol, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added" || change.type === "modified") {
          const data = change.doc.data();
          const { video, points } = data;
          if (!videosData[video]) return;
          videosData[video].votePoints += points;
        }
      });
      votesLoaded = true;
      if (videosLoaded) calculateScores();
    });

    function calculateScores() {
      for (const url in videosData) {
        const video = videosData[url];
        video.upvotePoints = video.redditUpvotes; // Reddit score
        video.totalScore = video.votePoints + video.upvotePoints;
      }
      renderLeaderboard();
      drawChart();
    }

    function renderLeaderboard() {
      const tbody = document.querySelector("#leaderboard tbody");
      tbody.innerHTML = "";
      Object.values(videosData)
        .sort((a,b) => b.totalScore - a.totalScore)
        .forEach(video => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><a href="${video.url}" target="_blank">${video.title}</a></td>
            <td>${video.redditUpvotes}</td>
            <td>${video.upvotePoints}</td>
            <td>${video.votePoints}</td>
            <td>${video.totalScore}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    function drawChart() {
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(() => {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Video");
        data.addColumn("number", "Total Score");

        Object.values(videosData).forEach(video => {
          data.addRow([video.title, video.totalScore]);
        });

        const options = {
          title: "Total Scores by Video",
          backgroundColor: "#111",
          legendTextStyle: { color: "#fff" },
          titleTextStyle: { color: "#fff" },
          hAxis: { textStyle: { color: "#fff" } },
          vAxis: { textStyle: { color: "#fff" } }
        };

        const chart = new google.visualization.ColumnChart(document.getElementById("chart_div"));
        chart.draw(data, options);
      });
    }

    // Reset votes only (not videos)
    document.getElementById("resetButton").addEventListener("click", async () => {
      if (!confirm("Delete ALL votes?")) return;
      const votesSnap = await getDocs(votesCol);
      for (const d of votesSnap.docs) {
        await deleteDoc(doc(db, "votes", d.id));
      }
      alert("All votes reset.");
      // Clear points in memory too
      for (const url in videosData) {
        videosData[url].votePoints = 0;
        videosData[url].totalScore = videosData[url].upvotePoints;
      }
      renderLeaderboard();
      drawChart();
    });

    // Initial load
    loadVideosFromJson();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ROTM Admin Dashboard</title>
<style>
body { font-family: Arial; background:#111; color:#fff; padding:20px; max-width:1200px; margin:auto; }
h1, h2 { text-align:center; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #555; padding:10px; text-align:center; }
th { background:#333; }
tr.top1 { background:#d4af37; color:#111; font-weight:bold; }
tr.top2 { background:#c0c0c0; color:#111; font-weight:bold; }
tr.top3 { background:#cd7f32; color:#111; font-weight:bold; }
button { margin-top:20px; padding:10px 20px; font-size:16px; cursor:pointer; }
.tab-buttons { text-align:center; margin-top:20px; }
.tab-buttons button { margin:0 5px; }
#resetButton { background-color: #c0392b; color: white; border: none; }
.tab { display:none; }
.tab.active { display:block; }
#authBox { text-align:center; margin-top:50px; }
#authBox button { background:#4285F4; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
#authStatus { margin-top:15px; font-size:16px; }
</style>
</head>
<body>
<h1>ROTM Admin Dashboard</h1>

<!-- Auth UI -->
<div id="authBox">
  <h2>Admin Login</h2>
  <button id="loginBtn">Sign in with Google</button>
  <div id="authStatus">Not signed in</div>
</div>

<!-- Admin Content -->
<div id="adminContent" style="display:none;">
  <div class="tab-buttons">
    <button id="scoresTabBtn">Scores</button>
    <button id="votesTabBtn">Detailed Votes</button>
    <button id="resetButton">Reset All Votes</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="scoresTab" class="tab active">
    <table id="rankingTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Video Title</th>
          <th>Reddit Upvotes</th>
          <th>Upvote Points</th>
          <th>Vote Points</th>
          <th>Total Score</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="votesTab" class="tab">
    <table id="votesTable">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Rank 1</th>
          <th>Rank 2</th>
          <th>Rank 3</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDChk83uv5LqXHemAziEHO3YAqEROHjIbo",
  authDomain: "rotm-2a088.firebaseapp.com",
  projectId: "rotm-2a088"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const authStatus = document.getElementById("authStatus");
const adminContent = document.getElementById("adminContent");

// ---------------- AUTH ----------------
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    authStatus.innerText = "Please sign in with your Google account...";
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      console.error("Login failed", e);
      authStatus.innerText = "Login required. Refresh to try again.";
      return;
    }
  } else {
    authStatus.innerText = "Signed in as " + user.email;
    adminContent.style.display = "block";
    initDashboard();
  }
});

// ---------------- DASHBOARD ----------------
function initDashboard() {
  const scoresTabBtn = document.getElementById("scoresTabBtn");
  const votesTabBtn = document.getElementById("votesTabBtn");
  const scoresTab = document.getElementById("scoresTab");
  const votesTab = document.getElementById("votesTab");
  const resetButton = document.getElementById("resetButton"); 

  scoresTabBtn.addEventListener("click", () => { scoresTab.classList.add("active"); votesTab.classList.remove("active"); });
  votesTabBtn.addEventListener("click", () => { votesTab.classList.add("active"); scoresTab.classList.remove("active"); });

  const videosCol = collection(db, "videos");
  const votesCol = collection(db, "votes");

  let videosData = {};
  let votesData = [];
  let videosLoaded = false;
  let votesLoaded = false;
  let rankingNeedsRender = false;

  // ---------------- FIRESTORE LISTENERS ----------------
  onSnapshot(videosCol, snapshot => {
    videosData = {};
    snapshot.docs.forEach(doc => {
      videosData[doc.id] = { ...doc.data(), votePoints:0, upvotePoints:0, totalScore:0 };
    });
    videosLoaded = true;
    if(votesLoaded) calculateScores();
    scheduleRenderRanking();
  });

  onSnapshot(votesCol, snapshot => {
    votesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    votesLoaded = true;
    if(videosLoaded) calculateScores();
    renderVotes(); // votes table doesn't need animation
    scheduleRenderRanking();
  });

  // ---------------- VISIBILITY HANDLING ----------------
  function scheduleRenderRanking() {
    if(document.visibilityState === "visible") {
      renderRanking();
      rankingNeedsRender = false;
    } else {
      rankingNeedsRender = true; // defer animation until tab active
    }
  }

  document.addEventListener("visibilitychange", () => {
    if(document.visibilityState === "visible" && rankingNeedsRender){
      renderRanking();
      rankingNeedsRender = false;
    }
  });

  // ---------------- SCORING ----------------
  function calculateScores() {
    if(!videosLoaded || !votesLoaded || Object.keys(videosData).length===0) return;

    Object.values(videosData).forEach(v => { v.votePoints=0; v.upvotePoints=0; v.totalScore=0; });

    votesData.forEach(vote=>{
      if(vote.rank1 && videosData[vote.rank1]) videosData[vote.rank1].votePoints += 100;
      if(vote.rank2 && videosData[vote.rank2]) videosData[vote.rank2].votePoints += 50;
      if(vote.rank3 && videosData[vote.rank3]) videosData[vote.rank3].votePoints += 25;
    });

    const sortedByUpvotes = Object.entries(videosData).sort((a,b)=>a[1].upvotes - b[1].upvotes);
    const step = 10;
    sortedByUpvotes.forEach(([id,v],i)=>{ videosData[id].upvotePoints = step*(i+1); });

    Object.values(videosData).forEach(v=>{ v.totalScore = v.votePoints + v.upvotePoints; });
  }

  // ---------------- ANIMATED RANKING ----------------
  function renderRanking() {
    const tbody = document.querySelector("#rankingTable tbody");
    const oldPositions = Array.from(tbody.children).map(row => row.getBoundingClientRect());

    const sorted = Object.entries(videosData).sort((a,b)=>b[1].totalScore - a[1].totalScore);

    // Create rows if empty
    while(tbody.children.length < sorted.length) {
      tbody.appendChild(document.createElement("tr"));
    }

    sorted.forEach(([id,v], i) => {
      const tr = tbody.children[i];
      tr.className = "";
      if(i===0) tr.classList.add("top1");
      else if(i===1) tr.classList.add("top2");
      else if(i===2) tr.classList.add("top3");

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${v.title}</td>
        <td>${v.upvotes || 0}</td>
        <td>${v.upvotePoints || 0}</td>
        <td>${v.votePoints || 0}</td>
        <td>${v.totalScore || 0}</td>
      `;
    });

    // FLIP animation
    const newPositions = Array.from(tbody.children).map(row => row.getBoundingClientRect());
    tbody.children.forEach((tr, i) => {
      const dx = oldPositions[i] ? oldPositions[i].left - newPositions[i].left : 0;
      const dy = oldPositions[i] ? oldPositions[i].top - newPositions[i].top : 0;
      if(dx || dy){
        tr.style.transition = "none";
        tr.style.transform = `translate(${dx}px, ${dy}px)`;
        requestAnimationFrame(()=>{
          tr.style.transition = "transform 1.2s ease-in-out";
          tr.style.transform = "";
        });
      }
    });
  }

  // ---------------- RENDER VOTES ----------------
  function renderVotes() {
    const tbody = document.querySelector("#votesTable tbody");
    tbody.innerHTML = "";
    if(!votesData || votesData.length===0 || Object.keys(videosData).length===0) return;

    votesData.slice().sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0))
      .forEach(v=>{
        const tr = document.createElement("tr");
        const ts = v.timestamp?.seconds ? new Date(v.timestamp.seconds*1000).toLocaleString() : "";
        tr.innerHTML = `
          <td>${v.userId || ""}</td>
          <td>${v.rank1 ? videosData[v.rank1]?.title || v.rank1 : ""}</td>
          <td>${v.rank2 ? videosData[v.rank2]?.title || v.rank2 : ""}</td>
          <td>${v.rank3 ? videosData[v.rank3]?.title || v.rank3 : ""}</td>
          <td>${ts}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // ---------------- RESET BUTTON ----------------
  resetButton.addEventListener('click', async () => {
    if(!confirm("Delete ALL votes permanently?")) return;
    try {
      const querySnapshot = await getDocs(votesCol);
      await Promise.all(querySnapshot.docs.map(doc=>deleteDoc(doc.ref)));
      alert("All votes reset successfully.");
    } catch(e) { console.error(e); alert("Failed to reset votes."); }
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ROTM Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#111; color:#fff;
      padding:20px; max-width:1200px; margin:auto;
    }
    h1,h2 { text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #555; padding:10px; text-align:center; }
    th { background:#333; }
    tr.top1 { background:#d4af37; color:#111; font-weight:bold; }
    tr.top2 { background:#c0c0c0; color:#111; font-weight:bold; }
    tr.top3 { background:#cd7f32; color:#111; font-weight:bold; }
    button { margin:10px; padding:10px 20px; font-size:16px; cursor:pointer; }
    .tab-buttons { text-align:center; margin-top:20px; }
    .tab-buttons button { margin:0 5px; }
    #resetButton { background-color: #c0392b; color: white; border: none; }
    .tab { display:none; }
    .tab.active { display:block; }
    #authBox { text-align:center; margin:20px; }
    #authStatus { margin-top:10px; font-size:18px; font-weight:bold; }
    #votesPieChart { max-width:600px; margin:20px auto; display:block; }
  </style>
</head>
<body>
  <h1>ROTM Admin Dashboard</h1>

  <!-- Authentication UI -->
  <div id="authBox">
    <button id="loginBtn">Sign in with Google</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <div id="authStatus">Not signed in</div>
  </div>

  <!-- Admin Content -->
  <div id="adminContent" style="display:none;">
    <div class="tab-buttons">
      <button id="scoresTabBtn">Scores</button>
      <button id="votesTabBtn">Detailed Votes</button>
      <button id="resetButton">Reset All Votes</button>
      <button id="exportCSVBtn">Export CSV</button>
    </div>

    <!-- Scores Tab -->
    <div id="scoresTab" class="tab active">
      <table id="rankingTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Video Title</th>
            <th>Reddit Upvotes</th>
            <th>Upvote Points</th>
            <th>Vote Points</th>
            <th>Total Score</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Votes Tab -->
    <div id="votesTab" class="tab">
      <canvas id="votesPieChart" width="400" height="400"></canvas>
      <table id="votesTable">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Rank 1</th>
            <th>Rank 2</th>
            <th>Rank 3</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + Chart.js -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDChk83uv5LqXHemAziEHO3YAqEROHjIbo",
      authDomain: "rotm-2a088.firebaseapp.com",
      projectId: "rotm-2a088"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- DOM elements ---
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");
    const authBox = document.getElementById("authBox");
    const adminContent = document.getElementById("adminContent");

    const scoresTabBtn = document.getElementById("scoresTabBtn");
    const votesTabBtn = document.getElementById("votesTabBtn");
    const scoresTab = document.getElementById("scoresTab");
    const votesTab = document.getElementById("votesTab");
    const resetButton = document.getElementById("resetButton");
    const exportCSVBtn = document.getElementById("exportCSVBtn");

    // --- Login ---
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error("Login failed:", e);
        authStatus.innerText = "Login failed. Try again.";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // --- Auth state listener ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authStatus.innerText = "Signed in as " + user.email;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        adminContent.style.display = "block";
        initDashboard();
      } else {
        authStatus.innerText = "Not signed in";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        adminContent.style.display = "none";
      }
    });

    // ---------------- Dashboard ----------------
    const videosCol = collection(db, "videos");
    const votesCol = collection(db, "votes");

    let videosData = {};
    let votesData = [];
    let videosLoaded = false;
    let votesLoaded = false;
    let rankingNeedsRender = false;
    let pieChart;

    function initDashboard() {
      // Firestore listeners
      onSnapshot(videosCol, snapshot => {
        videosData = {};
        snapshot.docs.forEach(doc => {
          videosData[doc.id] = { ...doc.data(), votePoints:0, upvotePoints:0, totalScore:0 };
        });
        videosLoaded = true;
        if(votesLoaded) calculateScores();
        scheduleRenderRanking();
      });

      onSnapshot(votesCol, snapshot => {
        votesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        votesLoaded = true;
        if(videosLoaded) calculateScores();
        renderVotes();
        scheduleRenderRanking();
      });

      // Tab switching
      scoresTabBtn.onclick = () => { scoresTab.classList.add("active"); votesTab.classList.remove("active"); };
      votesTabBtn.onclick = () => { votesTab.classList.add("active"); scoresTab.classList.remove("active"); };

      // Reset votes
      resetButton.onclick = async () => {
        if(!confirm("Delete ALL votes permanently?")) return;
        try {
          const querySnapshot = await getDocs(votesCol);
          await Promise.all(querySnapshot.docs.map(doc=>deleteDoc(doc.ref)));
          alert("All votes reset successfully.");
        } catch(e) {
          console.error(e);
          alert("Failed to reset votes.");
        }
      };

      // Export CSV
      exportCSVBtn.onclick = exportCSV;
    }

    // ---------------- Scoring ----------------
    function calculateScores() {
      if(!videosLoaded || !votesLoaded || Object.keys(videosData).length===0) return;

      // Score by votes (Rank 1=3pts, Rank2=2pts, Rank3=1pt)
      Object.values(videosData).forEach(v => { v.votePoints=0; v.upvotePoints=0; v.totalScore=0; });
      votesData.forEach(vote => {
        if(vote.rank1 && videosData[vote.rank1]) videosData[vote.rank1].votePoints+=3;
        if(vote.rank2 && videosData[vote.rank2]) videosData[vote.rank2].votePoints+=2;
        if(vote.rank3 && videosData[vote.rank3]) videosData[vote.rank3].votePoints+=1;
      });

      // Score by Reddit upvotes (ranking weight)
      const sortedByUpvotes = Object.entries(videosData).sort((a,b)=>(b[1].upvotes||0)-(a[1].upvotes||0));
      const step = sortedByUpvotes.length;
      sortedByUpvotes.forEach(([id,v],i)=>{ videosData[id].upvotePoints = step*(i+1); });

      // Total score
      Object.values(videosData).forEach(v=>{ v.totalScore = v.votePoints + v.upvotePoints; });

      renderRanking();
    }

    // ---------------- Ranking ----------------
    function scheduleRenderRanking() {
      if(document.visibilityState === "visible") {
        renderRanking();
        rankingNeedsRender = false;
      } else {
        rankingNeedsRender = true;
      }
    }
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible" && rankingNeedsRender){
        renderRanking();
        rankingNeedsRender = false;
      }
    });

    function renderRanking() {
      const tbody = document.querySelector("#rankingTable tbody");
      const sorted = Object.entries(videosData).sort((a,b)=>b[1].totalScore - a[1].totalScore);

      tbody.innerHTML = "";
      sorted.forEach(([id,v], i) => {
        const tr = document.createElement("tr");
        tr.dataset.id = id;
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${v.title}</td>
          <td>${v.upvotes || 0}</td>
          <td>${v.upvotePoints || 0}</td>
          <td>${v.votePoints || 0}</td>
          <td>${v.totalScore || 0}</td>
        `;
        tr.classList.remove("top1","top2","top3");
        if(i===0) tr.classList.add("top1");
        else if(i===1) tr.classList.add("top2");
        else if(i===2) tr.classList.add("top3");
        tbody.appendChild(tr);
      });
    }

    // ---------------- Votes ----------------
    function renderVotes() {
      const tbody = document.querySelector("#votesTable tbody");
      tbody.innerHTML = "";
      votesData.forEach(vote => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${vote.userId || "?"}</td>
          <td>${videosData[vote.rank1]?.title || "-"}</td>
          <td>${videosData[vote.rank2]?.title || "-"}</td>
          <td>${videosData[vote.rank3]?.title || "-"}</td>
          <td>${vote.timestamp || "-"}</td>
        `;
        tbody.appendChild(tr);
      });

      // Pie chart
      const counts = {};
      votesData.forEach(vote => { if(vote.rank1) counts[vote.rank1]=(counts[vote.rank1]||0)+1; });
      const labels = Object.keys(counts).map(id => videosData[id]?.title || id);
      const values = Object.values(counts);

      if(pieChart) pieChart.destroy();
      const ctx = document.getElementById("votesPieChart");
      pieChart = new Chart(ctx, {
        type: "pie",
        data: { labels, datasets: [{ data: values }] },
      });
    }

    // ---------------- Export CSV ----------------
    function exportCSV() {
      const rows = [["Rank","Video Title","Reddit Upvotes","Upvote Points","Vote Points","Total Score"]];
      const sorted = Object.entries(videosData).sort((a,b)=>b[1].totalScore - a[1].totalScore);
      sorted.forEach(([id,v], i) => {
        rows.push([i+1, v.title, v.upvotes||0, v.upvotePoints||0, v.votePoints||0, v.totalScore||0]);
      });
      let csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "ranking.csv"; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
